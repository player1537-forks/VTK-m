

Summit location:
/gpfs/alpine/proj-shared/csc143/pugmire/summit/XGC_analysis/XGC_analysis/poincare


Hager: 300K RK4 steps, 700-800 punctures = 428 steps per puncture.

my code:
step size, RK4 / puncture
0.05,  1400
0.005, 14000
0.1, 718
0.01, 7175
0.25, 287
0.20, 359
0.15, 479
0.075, 959
0.07, 1027

Timings on Summit: 10k points, 1200 punctures
stepsize, time
0.1, 192
0.7, 49
0.05, 332
0.25, 98



SKU
input file. sml_mstep=600k
at 1200 punctures: 500 steps / orbit


./examples/poincare/Simple2.3  --worklet 1 --vField XX --dir ../data/sku_8000/POINC --stepSize 0.01 --numPunc 10 --traces 0 --output bum --jong1



runs on summit:

DRP: eval_bicub_2 bicub_mod.F90
   x,y=     2.800000000000000         0.000000000000000
   xc,yc=     2.807999040000000        7.9990400000000666E-003
   dx, dy=   -7.9990400000005124E-003  -7.9990400000000666E-003
  acoef= [
   acoef(            0            0 )=    1.7609619162942647E-005
   acoef(            0            1 )=    2.2025069185917629E-003
   acoef(            0            2 )=    0.1377753121906410
   acoef(            0            3 )=    8.5101040685702147E-003
   acoef(            1            0 )=    2.2025069185918791E-003
   acoef(            1            1 )=    1.8141491861090625E-004
   acoef(            1            2 )=    5.5953686401247534E-003
   acoef(            1            3 )=   -0.4787594968287006
   acoef(            2            0 )=    0.1377753121906423
   acoef(            2            1 )=    5.5953686401129460E-003
   acoef(            2            2 )=    0.1757886526939748
   acoef(            2            3 )=    -14.49872798190554
   acoef(            3            0 )=    8.5101040683140394E-003
   acoef(            3            1 )=   -0.4787594968311299
   acoef(            3            2 )=    -14.49872798159208
   acoef(            3            3 )=     1285.765266624752
 ]
  use_fy=   F
  use_fy= FALSE
   f00, f01, f10, f11 =   -3.5169623762315794E-020  -4.0573899993141139E-018
  -7.6734190710454727E-017  -4.1337781168635804E-016
   f02, f20 =    0.2749823184852959        0.2749823184853093
    f00,f10,f10,f11=   -3.5169623762315794E-020  -7.6734190710454727E-017
  -7.6734190710454727E-017  -4.1337781168635804E-016
    f20,f02=    0.2749823184853093        0.2749823184852959
 DRP: bicub_interpol2() bicub_mod.f90 DONE
 DRP: psi_interpol(r,z, rd, zd) interpolation.f90     2.800000000000000
    0.000000000000000                 1            0
 DRP: psi_interpol after call bicu_interpol. psi=   -3.5169623762315794E-020
  -7.6734190710454727E-017  -4.0573899993141139E-018
 DRP: psi_interpol(r,z, rd, zd) interpolation.f90     2.800000000000000
    0.000000000000000                 0            1
 DRP: psi_interpol after call bicu_interpol. psi=   -3.5169623762315794E-020
  -7.6734190710454727E-017  -4.0573899993141139E-018
 DRP: bicub_interpol2() bicub_mod.f90 rz is     2.805203000000000
   1.1531000000000000E-002
   nr/nz/min/dr_inv=           150          150    1.600144000000000
   -1.199856000000000         62.50750090010835         62.50750090010835
   i,j=            76           76
   rc,zc=     2.807999040000000        7.9990400000000666E-003




cyclone:
DataSet:
  CoordSystems[1]
    Coordinate System    coords assoc= Points
  CellSet
   CellSetSingleType: Type=5
   CellPointIds:
     Shapes: valueType=unsigned char storageType=
     Connectivity: valueType=long long storageType=
     Offsets: valueType=long long storageType=
   PointCellIds:
     Not Allocated
  Fields[10]
   As_ff assoc= Mesh valueType=double
   As_phi_ff assoc= Mesh valueType=double
   coeff_1D assoc= Mesh valueType=double
   coeff_2D assoc= Mesh valueType=double
   dAs_ff_rzp assoc= Mesh valueType=vtkm::Vec<double, 3>
   dAs_phi_ff assoc= Mesh valueType=double
   eq_I assoc= Mesh valueType=double
   eq_psi_grid assoc= Mesh valueType=double
   eq_psi_rz assoc= Mesh valueType=double
   psi2D assoc= Points valueType=double




iter
DataSet:
  CoordSystems[1]
    Coordinate System    coords assoc= Points
  CellSet
   CellSetSingleType: Type=5
   CellPointIds:
     Shapes: valueType=unsigned char
     Connectivity: valueType=long long
     Offsets: valueType=long long
   PointCellIds:
     Not Allocated
  Fields[8]
   As_phi_ff assoc= Mesh valueType=double
   coeff_1D assoc= Mesh valueType=double
   coeff_2D assoc= Mesh valueType=double
   dAs_phi_ff assoc= Mesh valueType=double
   eq_I assoc= Mesh valueType=double
   eq_psi_grid assoc= Mesh valueType=double
   eq_psi_rz assoc= Mesh valueType=double
   psi2D assoc= Points valueType=double






Uniform As, dAs
64, 64
AsError: m/M 0 0.0017124 Avg= 8.30805e-05
dAsError: m/M 0 0.187909 Avg= 0.00633954

128, 128
AsError: m/M 0 0.00139152 Avg= 5.04781e-05
dAsError: m/M 0 0.171016 Avg= 0.00553445

256, 256
AsError: m/M 0 0.000762354 Avg= 2.71545e-05
dAsError: m/M 0 0.168878 Avg= 0.00430975

512, 512
AsError: m/M 0 0.000531075 Avg= 1.38219e-05
dAsError: m/M 0 0.163907 Avg= 0.00305653

1024, 1024

AsError: m/M 0 0.000298219 Avg= 6.94288e-06
dAsError: m/M 0 0.138446 Avg= 0.00188512

1024, 2048
AsError: m/M 0 0.000217496 Avg= 5.31274e-06
dAsError: m/M 0 0.131774 Avg= 0.00156493

2000, 4000
AsError: m/M 0 0.000119375 Avg= 2.69632e-06
dAsError: m/M 0 0.0858445 Avg= 0.000818306

4000, 8000
AsError: m/M 0 6.82741e-05 Avg= 1.34617e-06
dAsError: m/M 0 0.0443282 Avg= 0.000405618


2000, 5000
AsError: m/M 0 0.000119922 Avg= 2.5577e-06
dAsError: m/M 0 0.0858181 Avg= 0.000785382


With PrevCell:
********************************************************
  Timers
FindCell    : 20.767006523  3286452 avg: 6.3189745424549e-06
FindCellImpl: 12.209288772  2524566 avg: 4.8361931405239e-06
PointInCell : 12.803338266993  33774087 avg: 3.7908762025138e-07
*********************************************************

w/o PrevCell
*********************************************************
  Timers
FindCell    : 0  0 avg: -nan
FindCellImpl: 12.216213857  3286452 avg: 3.7171435508567e-06
PointInCell : 5.4034148489998  13668081 avg: 3.953309062918e-07
*********************************************************


cuda timings:
https://stackoverflow.com/questions/7876624/timing-cuda-operations



Using point in cell
PointInCell       : 18.537706510002  33774087 avg: 5.4887365304654e-07

2D triangle  specific.
PointInCell       : 18.113520089002  33774087 avg: 5.3631413009039e-07
PointInCell       : 17.684055220002  33765917 avg: 5.2372501004494e-07



Validation testing:
./examples/poincare/Poincare --openmp --dir /media/dpn/disk2TB/proj/vtkm/XGCLocator/data/XGC_GB/su458_ITER_data --output OUT  --numPunc 100 --gpuParams 256 128 --stepSize 0.5 --psiRange .1 1.0 10 --thetaRange 2 --openmp

Differences occur at particle # 9


UniformBinsCellLocator on summit:
*********These times are for cellLocator::LastCell not being used. Need to run with/without to verify.

//baseline with 2 level locator
jsrun -n1 -a1 -c20 -g1 ./examples/poincare/Poincare  --dir ../ITER-data --output ../scratch/OUT.0 --gpuParams 256 128 --stepSize 0.01 --psiRange .1 1.0 1000 --thetaRange 12 --UsePrevC
ell 1 --numPunc 1000 | tee out0 &

uniform bins:
jsrun -n1 -a1 -c20 -g1 ./examples/poincare/Poincare  --dir ../ITER-data --output ../scratch/OUT.1 --gpuParams 256 128 --stepSize 0.01 --psiRange .1 1.0 1000 --thetaRange 12 --UsePrevC
ell 1 --numPunc 1000 --UniformBins 2000 4000 | tee out1 &

2L time:
default: L1,L2 = 32, 2
CellLocatorTwoLevel:: Cell counts: 0 53
Locator build= 0.0541135
PoincareTime= 230.399475277

density:
1,10:  Cell counts: 0 53
1,100: Cell counts: 0 46
10,10: Cell counts: 0 46
100,1: Cell counts: 0 50
1000,1: Cell counts: 0 51
32, .1: Cell counts: 0 53
1, .1:  Cell counts: 0 53



UB:
1000x1000
CellLocatorUniformBins:: Cell counts: 0 110
Locator build= 0.0296618
PoincareTime= 256.408500293

2000x2000
CellLocatorUniformBins:: Cell counts: 0 49
Locator build= 0.0595085
PoincareTime= 184.142138402

4000x4000
Cell counts: 0 48
Locator build= 0.162479
PoincareTime= 155.843675556

8k x 8k
Cell counts: 0 47
Locator build= 0.549424
PoincareTime= 146.418014099


10k x 10k
Cell counts: 0 47
Locator build= 0.949674
PoincareTime= 143.371079293

12k x 12k
Cell counts: 0 46
Locator build= 1.26307
PoincareTime= 142.759388533

14k x 14k
Cell counts: mM 0 47 mean/avg= 2.23
Locator build= 1.94733
PoincareTime= 142.524495738

3k x 6k
Cell counts: 0 48
Locator build= 0.233432
PoincareTime= 153.500312937

7k x 14k
Cell counts: 0 47
Locator build= 0.943994
PoincareTime= 142.653902697

6k x 12k
Cell counts: 0 47
Locator build= 0.946948
PoincareTime= 142.739913316









2000x4000
CellLocatorUniformBins:: Cell counts: 0 49
Locator build= 0.0972067
PoincareTime= 168.015780924


4000x8000
CellLocatorUniformBins:: Cell counts: 0 48
Locator build= 0.313184
PoincareTime= 149.611008289

5000x10000
CellLocatorUniformBins:: Cell counts: 0 47
Locator build= 0.519389
PoincareTime= 145.920894894

16kx16k
Cell counts: 0 46
Locator build= 61.7286
PoincareTime= 211.871836648





Hager issue:
--psiVals .3  is not giving the right answer..


Hager example.
./examples/poincare/Poincare --openmp --dir /media/dpn/disk2TB/proj/vtkm/XGCLocator/data/hager --3DFile a_para_01010_d3d-170077.4500.bp --CoeffFile xgc.bfield.bp --output OUT  --numPunc 1 --stepSize 0.01 --psiVals 0.90 --thetaRange 1 --dumpSeeds

with sku's data:
./examples/poincare/Poincare --openmp --dir /media/dpn/disk2TB/proj/vtkm/XGCLocator/data/XGC_GB/su458_ITER_data --output OUT  --numPunc 1 --stepSize 0.01 --psiVals 0.90 --thetaRange 1 --dumpSeeds --dumpGrid





Hager's example:


./examples/poincare/Poincare --openmp --dir /media/dpn/disk2TB/proj/vtkm/XGCLocator/data/hager --3DFile a_para_04000_d3d-170077.4500.bp --CoeffFile xgc.bfield.bp --output OUT  --numPunc 100 --stepSize 0.01 --seed 1.983852890472070 0.4530218304452069 5.909587236523596 --traces 1


debug pt from summit for hager's data:
           8                      401 em_derivs_sp
            8                      401 DRP: PTL1_RZP:
    1.983628858390965        0.4533012129023550         6.183185307179587
            8                      401 B    1.691004807623796
            8                      401 Bsa    10.99324152344152
   -343.1504520652288         470.1905460631720
            8                      401 Bvec   0.2718814698503030
  -0.3351190353591867        -1.635014665958308
            8                      401 As    829.3602072950976
            8                      401 nb_curl_nb  -0.4640324845973328
            8                      401 curl_nb   1.3255086784661686E-002
  -0.4137532148840259        0.5669316443293883
            8                      401 curl_B  -4.3964410430160444E-002
   5.4190198477310270E-002   0.7931343794113532
            8                      401 em_derivs_sp

./examples/poincare/Poincare --openmp --dir /media/dpn/disk2TB/proj/vtkm/XGCLocator/data/hager --3DFile a_para_04000_d3d-170077.4500.bp --CoeffFile xgc.bfield.bp --output OUT  --numPunc 100 --stepSize 0.01 --seed 1.983628858390965 0.4533012129023550 6.183185307179587




XGC vs. VTKm

XGC
401 em_derivs_sp
401 DRP: PTL1_RZP: 1.983628858390965        0.4533012129023550         6.183185307179587
B    1.691004807623796
401 Bsa    10.99324152344152 -343.1504520652288         470.1905460631720
401 Bvec   0.2718814698503030 -0.3351190353591867        -1.635014665958308
401 As    829.3602072950976
401 nb_curl_nb  -0.4640324845973328
401 curl_nb   1.3255086784661686E-002 -0.4137532148840259        0.5669316443293883
401 curl_B  -4.3964410430160444E-002  5.4190198477310270E-002   0.7931343794113532


VTKm:
PT_RZP= [1.98362885839096,0.453301212902355,6.18318530717959]
 B0_rzp= [-0.271881469850308,  0.335119035359174,  1.63501466595831]
401 Bvec   0.2718814698503030 -0.3351190353591867 -1.635014665958308
 curl_nb_rzp= [-0.0166414464020078,0.481415422339912,-0.359766830122931]
 401 curl_nb   1.3255086784661686E-002 -0.4137532148840259        0.5669316443293883
  curl_B_rzp= [-0.0439644104301616,1.70269884871399,-0.793134379404692]
401 curl_B  -4.3964410430160444E-002  5.4190198477310270E-002   0.7931343794113532
  As= -3.09001010087221e-06
